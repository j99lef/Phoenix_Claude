<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - TravelAiGent</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Luxury Design System -->
    <link href="/static/luxury-concierge.css" rel="stylesheet">
    
    <style>
        /* Header Fixes */
        .luxury-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 1rem 0;
        }
        
        .luxury-header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }
        
        .luxury-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--luxury-obsidian, #1a1a1a);
        }
        
        .luxury-logo {
            height: 40px;
            width: auto;
        }
        
        .brand-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .luxury-nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .luxury-nav-link {
            text-decoration: none;
            color: var(--luxury-charcoal, #666);
            font-weight: 500;
            position: relative;
            transition: color 0.3s ease;
        }
        
        .luxury-nav-link:hover,
        .luxury-nav-link.active {
            color: var(--luxury-gold, #d4af37);
        }
        
        .luxury-nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--luxury-gold, #d4af37);
        }
        
        .luxury-profile {
            position: relative;
        }
        
        .luxury-profile-trigger {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background 0.3s ease;
        }
        
        .luxury-profile-trigger:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .luxury-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--luxury-gold, #d4af37);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .luxury-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            display: none;
            z-index: 1001;
        }
        
        .luxury-dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: var(--luxury-charcoal, #666);
            transition: all 0.3s ease;
        }
        
        .luxury-dropdown-item:hover {
            background: rgba(212, 175, 55, 0.1);
            color: var(--luxury-gold, #d4af37);
        }
        
        .luxury-dropdown-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 0.5rem 0;
        }
        
        /* Additional Profile Styles */
        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }
        
        .profile-title {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 400;
            color: var(--luxury-obsidian, #1a1a1a);
            margin-bottom: 0.5rem;
        }
        
        .profile-subtitle {
            color: var(--luxury-charcoal, #666);
            font-size: 1.25rem;
        }
        
        .profile-sections {
            display: grid;
            gap: 2rem;
        }
        
        .profile-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--luxury-obsidian, #1a1a1a);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .section-title i {
            color: var(--luxury-gold, #d4af37);
            font-size: 1.25rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--luxury-charcoal, #666);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            padding: 0.875rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--luxury-gold, #d4af37);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox-item:hover {
            border-color: var(--luxury-gold, #d4af37);
            background: rgba(212, 175, 55, 0.05);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-item.checked {
            border-color: var(--luxury-gold, #d4af37);
            background: rgba(212, 175, 55, 0.1);
        }
        
        .save-button {
            background: var(--luxury-gold, #d4af37);
            color: white;
            padding: 1rem 3rem;
            border: none;
            border-radius: 8px;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 3rem auto 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .save-button:hover {
            background: #b8941f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }
        
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--luxury-gold, #d4af37);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .luxury-header-content {
                flex-wrap: wrap;
                padding: 0 1rem;
            }
            
            .luxury-nav {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid #e0e0e0;
            }
            
            .luxury-brand {
                flex: 1;
            }
            
            .brand-name {
                font-size: 1.25rem;
            }
            
            .luxury-logo {
                height: 32px;
            }
            
            .profile-title {
                font-size: 2.5rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-container {
                padding: 1rem;
            }
            
            .profile-section {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <header class="luxury-header">
        <div class="luxury-header-content">
            <a href="/" class="luxury-brand">
                <img src="/static/logo.png" alt="TravelAiGent" class="luxury-logo">
                <span class="brand-name">TravelAiGent</span>
            </a>
            
            <nav class="luxury-nav">
                <a href="/" class="luxury-nav-link">Dashboard</a>
                <a href="/profile" class="luxury-nav-link active">Profile</a>
                <a href="/briefs" class="luxury-nav-link">Travel Briefs</a>
                <a href="/groups" class="luxury-nav-link">Travel Groups</a>
            </nav>
            
            <div class="luxury-profile">
                <div class="luxury-profile-trigger" onclick="toggleProfileDropdown(event)">
                    <div class="luxury-avatar">{{ (user.first_name[:1] if user and user.first_name else (user.username[:1] if user and user.username else 'U')) | upper }}</div>
                    <span>{{ (user.first_name or user.username) if user else 'User' }}</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="luxury-dropdown-menu" id="profileDropdown">
                    <a href="/profile" class="luxury-dropdown-item">
                        <i class="fas fa-user"></i>
                        Profile Settings
                    </a>
                    <a href="/account" class="luxury-dropdown-item">
                        <i class="fas fa-cog"></i>
                        Account Settings
                    </a>
                    <div class="luxury-dropdown-divider"></div>
                    <a href="/logout" class="luxury-dropdown-item">
                        <i class="fas fa-sign-out-alt"></i>
                        Sign Out
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="profile-container">
        <div class="profile-header">
            <h1 class="profile-title">Your Profile</h1>
            <p class="profile-subtitle">Customize your travel preferences and personal information</p>
        </div>
        
        <div id="alertMessage" class="alert"></div>
        
        <form id="profileForm" onsubmit="saveProfile(event)">
            <!-- Hidden field for existing term dates -->
            <input type="hidden" name="existing_term_dates" value="{{ existing_term_dates or '{}' }}">
            
            <div class="profile-sections">
                <!-- Personal Information -->
                <div class="profile-section">
                    <h2 class="section-title">
                        <i class="fas fa-user"></i>
                        Personal Information
                    </h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-input" name="first_name" 
                                   value="{{ user.first_name or '' }}" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-input" name="last_name" 
                                   value="{{ user.last_name or '' }}" placeholder="Doe">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" name="email" 
                                   value="{{ user.email or '' }}" placeholder="john.doe@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" name="phone" 
                                   value="{{ user.phone or '' }}" placeholder="+1 (555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp Number</label>
                            <input type="tel" class="form-input" name="whatsapp_number" 
                                   value="{{ user.whatsapp_number or user.phone or '' }}" 
                                   placeholder="+1 (555) 123-4567">
                        </div>
                    </div>
                </div>
                
                <!-- Travel Preferences -->
                <div class="profile-section">
                    <h2 class="section-title">
                        <i class="fas fa-plane"></i>
                        Travel Preferences
                    </h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Home Airports</label>
                            <input type="text" class="form-input" name="home_airports" 
                                   value="{{ user.home_airports or '' }}" 
                                   placeholder="LHR, LGW, STN (comma separated)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Airlines</label>
                            <input type="text" class="form-input" name="preferred_airlines" 
                                   value="{{ user.preferred_airlines or '' }}" 
                                   placeholder="BA, Emirates, Singapore (comma separated)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Flight Class</label>
                            <select class="form-select" name="travel_style">
                                <option value="economy" {% if user.travel_style == 'economy' or not user.travel_style %}selected{% endif %}>Economy</option>
                                <option value="premium_economy" {% if user.travel_style == 'premium_economy' %}selected{% endif %}>Premium Economy</option>
                                <option value="business" {% if user.travel_style == 'business' %}selected{% endif %}>Business Class</option>
                                <option value="first" {% if user.travel_style == 'first' %}selected{% endif %}>First Class</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Travel Group -->
                <div class="profile-section">
                    <h2 class="section-title">
                        <i class="fas fa-users"></i>
                        Travel Group
                    </h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Number of Adults</label>
                            <input type="number" class="form-input" name="adults_count" 
                                   value="{{ user.adults_count or 2 }}" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Children Ages</label>
                            <input type="text" class="form-input" name="children_ages" 
                                   value="{{ user.children_ages or '' }}" 
                                   placeholder="e.g., 5, 8, 12 (comma separated)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Senior Travelers (65+)</label>
                            <select class="form-select" name="senior_travelers">
                                <option value="false" {% if not user.senior_travelers %}selected{% endif %}>No</option>
                                <option value="true" {% if user.senior_travelers %}selected{% endif %}>Yes</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Accommodation Preferences -->
                <div class="profile-section">
                    <h2 class="section-title">
                        <i class="fas fa-bed"></i>
                        Accommodation Preferences
                    </h2>
                    <div class="checkbox-group" id="accommodationPrefs">
                        <label class="checkbox-item">
                            <input type="checkbox" name="preferred_accommodation" value="5-star-hotels" 
                                   {% if user.preferred_accommodation and '5-star-hotels' in user.preferred_accommodation %}checked{% endif %}>
                            <span>5-Star Hotels</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="preferred_accommodation" value="4-star-hotels" 
                                   {% if user.preferred_accommodation and '4-star-hotels' in user.preferred_accommodation %}checked{% endif %}>
                            <span>4-Star Hotels</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="preferred_accommodation" value="boutique-hotels" 
                                   {% if user.preferred_accommodation and 'boutique-hotels' in user.preferred_accommodation %}checked{% endif %}>
                            <span>Boutique Hotels</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="preferred_accommodation" value="resorts" 
                                   {% if user.preferred_accommodation and 'resorts' in user.preferred_accommodation %}checked{% endif %}>
                            <span>Resorts</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="preferred_accommodation" value="vacation-rentals" 
                                   {% if user.preferred_accommodation and 'vacation-rentals' in user.preferred_accommodation %}checked{% endif %}>
                            <span>Vacation Rentals</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="preferred_accommodation" value="all-inclusive" 
                                   {% if user.preferred_accommodation and 'all-inclusive' in user.preferred_accommodation %}checked{% endif %}>
                            <span>All-Inclusive</span>
                        </label>
                    </div>
                </div>
                
                <!-- Location & School Settings -->
                <div class="profile-section">
                    <h2 class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Location & School Calendar
                    </h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Country</label>
                            <select class="form-select" name="country" id="countrySelect" onchange="updateSchoolInfo()">
                                <option value="">Select your country</option>
                                <option value="England" {% if school_calendar and school_calendar.country == 'England' %}selected{% endif %}>England</option>
                                <option value="Scotland" {% if school_calendar and school_calendar.country == 'Scotland' %}selected{% endif %}>Scotland</option>
                                <option value="Wales" {% if school_calendar and school_calendar.country == 'Wales' %}selected{% endif %}>Wales</option>
                                <option value="Northern Ireland" {% if school_calendar and school_calendar.country == 'Northern Ireland' %}selected{% endif %}>Northern Ireland</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Manage School Terms</label>
                            <button type="button" id="editTermsBtn" onclick="toggleTermEditor()" class="btn-secondary" style="background: #007bff; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; width: 100%;">
                                <i class="fas fa-calendar-alt"></i> Edit Term Dates
                            </button>
                        </div>
                    </div>
                    
                    <!-- Term Dates Editor (Hidden by default) -->
                    <div id="termDatesEditor" style="display: none; margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin-bottom: 1.5rem; color: #333;">
                            <i class="fas fa-edit"></i> Edit School Term Dates
                            <span id="countryIndicator" style="font-size: 1rem; font-weight: normal; color: #666; margin-left: 1rem;"></span>
                        </h3>
                        
                        <!-- Current Year Terms -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 1rem; color: #555;">2025 School Terms</h4>
                            <div class="term-dates-grid" style="display: grid; gap: 1rem;">
                                <div class="term-row">
                                    <label class="form-label">Spring Half Term</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="spring_half_term_start_2025" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="spring_half_term_end_2025" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="term-row">
                                    <label class="form-label">Easter Holidays</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="easter_holidays_start_2025" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="easter_holidays_end_2025" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="term-row">
                                    <label class="form-label">May Half Term</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="may_half_term_start_2025" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="may_half_term_end_2025" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="term-row">
                                    <label class="form-label">Summer Holidays</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="summer_holidays_start_2025" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="summer_holidays_end_2025" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="term-row">
                                    <label class="form-label">Autumn Half Term</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="autumn_half_term_start_2025" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="autumn_half_term_end_2025" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="term-row">
                                    <label class="form-label">Christmas Holidays</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="christmas_holidays_start_2025" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="christmas_holidays_end_2025" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Next Year Terms -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 1rem; color: #555;">2026 School Terms</h4>
                            <div class="term-dates-grid" style="display: grid; gap: 1rem;">
                                <div class="term-row">
                                    <label class="form-label">Spring Half Term</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="spring_half_term_start_2026" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="spring_half_term_end_2026" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="term-row">
                                    <label class="form-label">Easter Holidays</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="easter_holidays_start_2026" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="easter_holidays_end_2026" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="term-row">
                                    <label class="form-label">May Half Term</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="may_half_term_start_2026" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="may_half_term_end_2026" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="term-row">
                                    <label class="form-label">Summer Holidays</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="summer_holidays_start_2026" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="summer_holidays_end_2026" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="term-row">
                                    <label class="form-label">Autumn Half Term</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="autumn_half_term_start_2026" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="autumn_half_term_end_2026" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="term-row">
                                    <label class="form-label">Christmas Holidays</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="date" name="christmas_holidays_start_2026" class="form-input" style="flex: 1;">
                                        <span>to</span>
                                        <input type="date" name="christmas_holidays_end_2026" class="form-input" style="flex: 1;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button type="button" onclick="loadDefaultTermDates()" class="btn-secondary" style="background: #6c757d; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px;">
                                Load Default Dates
                            </button>
                            <button type="button" onclick="toggleTermEditor()" class="btn-secondary" style="background: #28a745; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px;">
                                Done Editing
                            </button>
                        </div>
                    </div>
                    
                    <!-- INSET Days -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label class="form-label">Personal INSET Days</label>
                        <p style="font-size: 0.875rem; color: #666; margin-bottom: 1rem;">
                            Add your school's specific INSET/Teacher Training days
                        </p>
                        <div id="insetDaysList" style="margin-bottom: 1rem;">
                            {% if school_calendar and school_calendar.inset_days %}
                                {% for day in school_calendar.inset_days %}
                                <div class="inset-day-item" style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                                    <input type="date" value="{{ day.date }}" name="inset_dates[]" class="form-input" style="flex: 1;">
                                    <input type="text" value="{{ day.description or '' }}" name="inset_descriptions[]" placeholder="Description" class="form-input" style="flex: 2;">
                                    <button type="button" onclick="removeInsetDay(this)" class="btn-remove" style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px;">Remove</button>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button type="button" onclick="addInsetDay()" class="btn-secondary" style="background: #6c757d; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px;">
                            Add INSET Day
                        </button>
                    </div>
                </div>
                
                <!-- Special Requirements -->
                <div class="profile-section">
                    <h2 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Special Requirements
                    </h2>
                    <div class="form-group">
                        <label class="form-label">Dietary Restrictions & Special Needs</label>
                        <textarea class="form-textarea" name="dietary_restrictions" 
                                  placeholder="e.g., Vegetarian, Gluten-free, Wheelchair accessible, Pet-friendly">{{ user.dietary_restrictions or '' }}</textarea>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="save-button" id="saveBtn">
                Save Profile
            </button>
        </form>
    </div>
    
    <script>
        // Simple, CSP-compliant JavaScript (no eval, no inline event handlers)
        
        // Profile dropdown toggle
        function toggleProfileDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('profileDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) dropdown.style.display = 'none';
        });
        
        // Handle checkbox styling
        document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(checkbox => {
            // Set initial state
            if (checkbox.checked) {
                checkbox.parentElement.classList.add('checked');
            }
            
            // Handle changes
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    this.parentElement.classList.add('checked');
                } else {
                    this.parentElement.classList.remove('checked');
                }
            });
        });
        
        // Save profile function
        async function saveProfile(event) {
            event.preventDefault();
            
            const form = event.target;
            const saveBtn = document.getElementById('saveBtn');
            const alertDiv = document.getElementById('alertMessage');
            
            // Show loading state
            saveBtn.innerHTML = 'Saving... <span class="loading"></span>';
            saveBtn.disabled = true;
            
            // Collect form data
            const formData = new FormData(form);
            const data = {};
            
            // Convert form data to object
            const termDates = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'preferred_accommodation') {
                    // Handle multiple checkbox values
                    if (!data[key]) data[key] = [];
                    data[key].push(value);
                } else if (key === 'inset_dates[]') {
                    // Handle INSET dates array
                    if (!data['inset_dates']) data['inset_dates'] = [];
                    data['inset_dates'].push(value);
                } else if (key === 'inset_descriptions[]') {
                    // Handle INSET descriptions array
                    if (!data['inset_descriptions']) data['inset_descriptions'] = [];
                    data['inset_descriptions'].push(value);
                } else if (key.includes('_start_') || key.includes('_end_')) {
                    // Collect term dates separately
                    termDates[key] = value;
                } else {
                    data[key] = value;
                }
            }
            
            // Add term dates to data if any were set
            if (Object.keys(termDates).length > 0) {
                data['term_dates'] = termDates;
            }
            
            // Convert arrays to comma-separated strings for certain fields
            if (data.preferred_accommodation) {
                data.preferred_accommodation = data.preferred_accommodation.join(',');
            }
            
            // Convert senior_travelers to boolean
            data.senior_travelers = data.senior_travelers === 'true';
            
            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Show success message
                    alertDiv.className = 'alert alert-success';
                    alertDiv.textContent = 'Profile saved successfully!';
                    alertDiv.style.display = 'block';
                    
                    // Scroll to top to show message
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    // Hide message after 5 seconds
                    setTimeout(() => {
                        alertDiv.style.display = 'none';
                    }, 5000);
                } else {
                    // Show error message
                    alertDiv.className = 'alert alert-error';
                    alertDiv.textContent = 'Error saving profile: ' + (result.error || 'Unknown error');
                    alertDiv.style.display = 'block';
                }
            } catch (error) {
                // Show network error
                alertDiv.className = 'alert alert-error';
                alertDiv.textContent = 'Network error: ' + error.message;
                alertDiv.style.display = 'block';
            } finally {
                // Reset button state
                saveBtn.innerHTML = 'Save Profile';
                saveBtn.disabled = false;
            }
        }
        
        // Auto-format phone numbers
        document.querySelectorAll('input[type="tel"]').forEach(input => {
            input.addEventListener('input', function(e) {
                // Remove non-numeric characters except + and spaces
                let value = e.target.value.replace(/[^\d\s+]/g, '');
                e.target.value = value;
            });
        });
        
        // Default term dates by country
        const DEFAULT_TERM_DATES = {
            'England': {
                2025: {
                    'spring_half_term': { start: '2025-02-17', end: '2025-02-21' },
                    'easter_holidays': { start: '2025-04-14', end: '2025-04-25' },
                    'may_half_term': { start: '2025-05-26', end: '2025-05-30' },
                    'summer_holidays': { start: '2025-07-21', end: '2025-09-01' },
                    'autumn_half_term': { start: '2025-10-27', end: '2025-10-31' },
                    'christmas_holidays': { start: '2025-12-22', end: '2026-01-05' }
                },
                2026: {
                    'spring_half_term': { start: '2026-02-16', end: '2026-02-20' },
                    'easter_holidays': { start: '2026-04-03', end: '2026-04-17' },
                    'may_half_term': { start: '2026-05-25', end: '2026-05-29' },
                    'summer_holidays': { start: '2026-07-22', end: '2026-09-02' },
                    'autumn_half_term': { start: '2026-10-26', end: '2026-10-30' },
                    'christmas_holidays': { start: '2026-12-21', end: '2027-01-04' }
                }
            },
            'Scotland': {
                2025: {
                    'spring_half_term': { start: '2025-02-10', end: '2025-02-14' },
                    'easter_holidays': { start: '2025-04-07', end: '2025-04-18' },
                    'may_half_term': { start: '2025-05-05', end: '2025-05-06' },
                    'summer_holidays': { start: '2025-06-27', end: '2025-08-18' },
                    'autumn_half_term': { start: '2025-10-13', end: '2025-10-17' },
                    'christmas_holidays': { start: '2025-12-22', end: '2026-01-05' }
                },
                2026: {
                    'spring_half_term': { start: '2026-02-09', end: '2026-02-13' },
                    'easter_holidays': { start: '2026-03-30', end: '2026-04-10' },
                    'may_half_term': { start: '2026-05-04', end: '2026-05-05' },
                    'summer_holidays': { start: '2026-06-26', end: '2026-08-17' },
                    'autumn_half_term': { start: '2026-10-12', end: '2026-10-16' },
                    'christmas_holidays': { start: '2026-12-21', end: '2027-01-04' }
                }
            },
            'Wales': {
                2025: {
                    'spring_half_term': { start: '2025-02-17', end: '2025-02-21' },
                    'easter_holidays': { start: '2025-04-14', end: '2025-04-25' },
                    'may_half_term': { start: '2025-05-26', end: '2025-05-30' },
                    'summer_holidays': { start: '2025-07-21', end: '2025-09-01' },
                    'autumn_half_term': { start: '2025-10-27', end: '2025-10-31' },
                    'christmas_holidays': { start: '2025-12-22', end: '2026-01-05' }
                },
                2026: {
                    'spring_half_term': { start: '2026-02-16', end: '2026-02-20' },
                    'easter_holidays': { start: '2026-04-03', end: '2026-04-17' },
                    'may_half_term': { start: '2026-05-25', end: '2026-05-29' },
                    'summer_holidays': { start: '2026-07-20', end: '2026-08-31' },
                    'autumn_half_term': { start: '2026-10-26', end: '2026-10-30' },
                    'christmas_holidays': { start: '2026-12-21', end: '2027-01-04' }
                }
            },
            'Northern Ireland': {
                2025: {
                    'spring_half_term': { start: '2025-02-17', end: '2025-02-18' },
                    'easter_holidays': { start: '2025-04-14', end: '2025-04-25' },
                    'may_half_term': { start: '2025-05-26', end: '2025-05-26' },
                    'summer_holidays': { start: '2025-07-01', end: '2025-08-29' },
                    'autumn_half_term': { start: '2025-10-27', end: '2025-10-31' },
                    'christmas_holidays': { start: '2025-12-22', end: '2026-01-02' }
                },
                2026: {
                    'spring_half_term': { start: '2026-02-16', end: '2026-02-17' },
                    'easter_holidays': { start: '2026-04-01', end: '2026-04-10' },
                    'may_half_term': { start: '2026-05-25', end: '2026-05-25' },
                    'summer_holidays': { start: '2026-07-01', end: '2026-08-31' },
                    'autumn_half_term': { start: '2026-10-26', end: '2026-10-30' },
                    'christmas_holidays': { start: '2026-12-21', end: '2027-01-01' }
                }
            }
        };
        
        // School calendar functions
        function updateSchoolInfo() {
            const country = document.getElementById('countrySelect').value;
            const editBtn = document.getElementById('editTermsBtn');
            const editor = document.getElementById('termDatesEditor');
            
            if (country) {
                editBtn.style.display = 'block';
                // Hide the editor when country changes (user needs to click Edit again)
                editor.style.display = 'none';
            } else {
                editBtn.style.display = 'none';
                editor.style.display = 'none';
            }
        }
        
        function toggleTermEditor() {
            const editor = document.getElementById('termDatesEditor');
            const isVisible = editor.style.display === 'block';
            editor.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                const country = document.getElementById('countrySelect').value;
                if (country) {
                    // Update country indicator
                    document.getElementById('countryIndicator').textContent = `(${country})`;
                    
                    // First check if we have saved dates
                    const savedDates = loadTermDatesIfAvailable();
                    
                    // If no saved dates, load the defaults for the selected country
                    if (!savedDates) {
                        loadDefaultTermDates();
                    }
                }
            }
        }
        
        function loadDefaultTermDates() {
            const country = document.getElementById('countrySelect').value;
            if (!country || !DEFAULT_TERM_DATES[country]) {
                alert('Please select a country first');
                return;
            }
            
            const dates = DEFAULT_TERM_DATES[country];
            let fieldsUpdated = 0;
            
            // Load 2025 dates
            Object.keys(dates[2025]).forEach(term => {
                const startInput = document.querySelector(`input[name="${term}_start_2025"]`);
                const endInput = document.querySelector(`input[name="${term}_end_2025"]`);
                if (startInput && endInput) {
                    startInput.value = dates[2025][term].start;
                    endInput.value = dates[2025][term].end;
                    fieldsUpdated += 2;
                }
            });
            
            // Load 2026 dates
            Object.keys(dates[2026]).forEach(term => {
                const startInput = document.querySelector(`input[name="${term}_start_2026"]`);
                const endInput = document.querySelector(`input[name="${term}_end_2026"]`);
                if (startInput && endInput) {
                    startInput.value = dates[2026][term].start;
                    endInput.value = dates[2026][term].end;
                    fieldsUpdated += 2;
                }
            });
            
            // Show feedback
            if (fieldsUpdated > 0) {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Dates Loaded!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#6c757d';
                }, 2000);
            }
        }
        
        function loadTermDatesIfAvailable() {
            // Check if we have existing term dates saved
            const existingDates = document.querySelector('input[type="hidden"][name="existing_term_dates"]');
            if (existingDates && existingDates.value && existingDates.value !== '{}') {
                try {
                    const dates = JSON.parse(existingDates.value);
                    
                    // Check if we actually have dates
                    if (Object.keys(dates).length > 0) {
                        // Populate form fields with existing dates
                        Object.keys(dates).forEach(termKey => {
                            const input = document.querySelector(`input[name="${termKey}"]`);
                            if (input) {
                                input.value = dates[termKey];
                            }
                        });
                        return true; // Found and loaded saved dates
                    }
                } catch (e) {
                    console.error('Error loading existing term dates:', e);
                }
            }
            return false; // No saved dates found
        }
        
        function addInsetDay() {
            const container = document.getElementById('insetDaysList');
            const dayDiv = document.createElement('div');
            dayDiv.className = 'inset-day-item';
            dayDiv.style.cssText = 'display: flex; gap: 1rem; margin-bottom: 0.5rem;';
            
            dayDiv.innerHTML = `
                <input type="date" name="inset_dates[]" class="form-input" style="flex: 1;" required>
                <input type="text" name="inset_descriptions[]" placeholder="Description" class="form-input" style="flex: 2;">
                <button type="button" onclick="removeInsetDay(this)" class="btn-remove" style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px;">Remove</button>
            `;
            
            container.appendChild(dayDiv);
        }
        
        function removeInsetDay(button) {
            button.parentElement.remove();
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Profile page loaded successfully');
        });
    </script>
</body>
</html>